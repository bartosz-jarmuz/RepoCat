@using RepoCat.Portal.Areas.Catalog.Models
@using RepoCat.RepositoryManagement.Service

@model ProjectsTableModel

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <partial name="_projects-busy-spinner" />
            <div class="card-body">
                <div class="collapse" id="SearchPanesCard"></div>
                <div class="row">
                    <div class="col-md-12" id="PropertyFilters">
                    </div>
                </div>
                <div id="HiddenPropertyFilters" class="row">
                    <div class="col-md-12">
                        @foreach (var property in Model.Properties)
                        {
                            <span style="display:none;" class="filter-host">
                                <span style="display:inline-block; vertical-align: top;">
                                    <partial name="_BadgeProperty" model="@(new PropertyBadgeViewModel(property, "filter-toggle filter-label", "fas fa-filter"))" />
                                    <select class="form-control select2 select2-inline property-filter" multiple="multiple" data-allow-clear="1" data-toggle="tooltip" 
                                            style="width: 20em;" data-property="@property.Key"
                                            title="Filter by @property.Key" placeholder="Click to add a new filter">
                                        @foreach (var value in property.Values)
                                        {
                                            <option value="@value.Value">@value.Value (@value.OccurenceCount)</option>
                                        }
                                    </select>
                                </span>
                            </span>
                        }
                    </div>
                </div>
                <div class="row">

                    <div class="col-12">
                        <div style="display: inline-block; margin-right:5px;">
                            <small class="help-block text-secondary">Table filters</small>
                            <div>
                                <span>
                                    <span class="badge badge-button"
                                          data-toggle="collapse"
                                          data-target="#SearchPanesCard" id="SearchPanesCollapser">
                                        <i class="fas fa-plus"></i>
                                        Show
                                    </span>
                                </span>

                            </div>

                        </div>
                        <div style="display: inline-block;">
                            <small class="help-block text-secondary">Filter by properties</small>
                            <div id="PropertyFilterButtons" style="margin-bottom: 0.1em; ">
                                <span>
                                    @foreach (var property in Model.Properties)
                                    {
                                        <partial name="_BadgeProperty" model="@(new PropertyBadgeViewModel(property, "filter-toggle add-filter", "fas fa-filter"))" />
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">

                        <small class="help-block text-secondary">Add /Remove custom columns</small>
                        <div id="PropertyColumnsButtons" style="margin-bottom: 0.1em;">
                            <span>
                                @foreach (var property in Model.Properties)
                                {
                                    <partial name="_BadgeProperty" model="@(new PropertyBadgeViewModel(property, "add-column", "fas fa-columns"))" />
                                }
                            </span>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="ResultsTableData" data-showrepositorycolumn="@(Model.IsMultipleRepositories)" data-numberofextracolumns="0" />
                <table id="ResultsTable" class="table table-striped table-bordered wrap  project-card" width="100%">
                    <thead>
                        <tr>
                            <!--Expander button-->
                            <th></th>
                            <!--Hidden content for expanded row-->
                            <th style="display:none;"></th>
                            <th class="repository-name">Repository</th>
                            <th style="min-width: 10%;">Project Name</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Documentation</th>
                            <th>Tags</th>
                            <th style="min-width: 20%;">Properties</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (ProjectInfoViewModel project in Model.Projects)
                        {
                            <tr class="component project-row">
                                <!--Expander button-->
                                <td></td>
                                <!--Hidden content for expanded row-->
                                <td class="break-all"><div class="details-view" style="display:none;"><partial name="_ProjectViewPartial" for="@project" /></div></td>
                                <td class="break-all"><div class="repository-name"><partial name="_BadgeRepository" model="@(new RepositoryQueryParameter(project.OrganizationName, project.RepositoryName))" /></div></td>
                                <td class="break-all" data-order="@project.ProjectName"><partial name="_CellProjectName" for="@project" /></td>
                                <td class="break-all"><partial name="_BadgeProjectType" for="@project" /></td>
                                <td class="break-word"><partial name="_CellProjectDescription" for="@project" /></td>
                                <td class="break-all"><partial name="_CellProjectDocumentationUri" for="@project" /></td>
                                <td class="break-all"><partial name="_CellProjectTags" for="@project" /></td>
                                <td class="break-word properties"><partial name="_CellProjectProperties" for="@project" /></td>
                            </tr>
                        }
                    </tbody>
                </table>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    docReady(function () {
        if (getCookie('searchPanesOpen') == 'false') {
            $('#SearchPanesCard').removeClass('show');
            setArrowDown($('#SearchPanesCollapser').find('.toggler-icon'));
        }



        showActiveFilters();

        $.fn.dataTable.ext.search.push(
            function (settings, searchData, index, rowData, counter) {
                return propertyFilter(settings, searchData, index, rowData, counter);
            }
        );


        //var activeColumnsCookie = getCookie('activeColumns');

        showOverlay();
        setTimeout(function () {
            var table = getProjectsTable();
            setupTableFeatures(table);
            hideOverlay();
        }, 10);

    });

</script>
